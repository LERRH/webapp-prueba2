<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Emergencias - Bomberos Per√∫</title>
    <link rel="icon" type="image/svg+xml" href="../../assets/icons/logo.svg">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .header {
            background: #ffffff;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-btn {
            color: #75020f;
            text-decoration: none;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.95rem;
            color: #666;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .aviso-importante {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }

        .aviso-importante strong {
            color: #856404;
            display: block;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .aviso-importante p {
            color: #856404;
            font-size: 0.9rem;
            margin: 0;
        }

        .controles {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-actualizacion {
            font-size: 0.95rem;
        }

        .btn-actualizar {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-actualizar:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-actualizar:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }

        .emergencias-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .emergencia-card {
            background: #f8f8f8;
            border-left: 5px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .emergencia-card:hover {
            background: #f0f0f0;
        }

        .emergencia-card.incendio { border-left-color: #f97316; }
        .emergencia-card.medica { border-left-color: #ef4444; }
        .emergencia-card.peligroso { border-left-color: #eab308; }

        .badge-nueva {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-bottom: 12px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%,100% {opacity:1;} 50% {opacity:0.7;} }

        .emergencia-info { width: 100%; }

        .tipo { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-bottom: 10px; 
            color: #1a1a1a; 
            line-height: 1.4;
        }

        .direccion { 
            font-size: 0.95rem; 
            color: #374151; 
            margin-bottom: 8px; 
        }

        .maquinas {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .tags { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
        .tag { padding:5px 12px; border-radius:6px; font-size:0.85rem; font-weight:600; }
        .tag-numero { background:#dbeafe; color:#1e40af; }
        .tag-estado { background:#d1fae5; color:#065f46; }

        .botones { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
        .btn { flex:1; padding:10px; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; transition:all 0.3s; }
        .btn-maps { background:#2563eb; color:white; }
        .btn-maps:hover { background:#1d4ed8; }
        .btn-waze { background:#06b6d4; color:white; }
        .btn-waze:hover { background:#0891b2; }

        .sin-coordenadas {
            color: #ef4444;
            font-weight: 600;
            margin-top: 10px;
        }

        .loading, .error-message { text-align:center; padding:40px 20px; }
        .loading-spinner, .error-icon { font-size:3rem; margin-bottom:15px; }

        .footer { text-align:center; color:#9ca3af; font-size:0.9rem; line-height:1.6; margin-top:25px; }

        @media(max-width:768px){
            .container{padding:20px 15px;}
            .header h1{font-size:1.5rem;}
            .header p{font-size:0.9rem;}
            .controles{flex-direction:column; align-items:stretch; text-align:center;}
            .btn-actualizar{width:100%; justify-content:center;}
            .botones{flex-direction:column;}
            .aviso-importante { padding: 12px 15px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="../../SegundaPantalla/index3.html" class="back-btn">‚Üê Volver</a>
        <h1>Emergencias en Tiempo Real</h1>
        <p>√öltimas emergencias reportadas a Bomberos Per√∫ - Norte</p>
    </header>

    <div class="container">
        <div class="aviso-importante">
            <strong>‚ö†Ô∏è Aviso Importante</strong>
            <p>Las direcciones est√°n calculadas en base a las coordenadas reportadas en <strong>sgonorte.bomberosperu.gob.pe/24horas</strong>. Siempre corroborar con el 10.18 proporcionado por la central de comunicaciones.</p>
        </div>

        <div class="controles">
            <div class="info-actualizacion" id="ultima-actualizacion">
                Presiona el bot√≥n para cargar emergencias
            </div>
            <button class="btn-actualizar" id="btn-actualizar" onclick="actualizarManual()">
                Actualizar Ahora
            </button>
        </div>

        <div class="emergencias-container" id="emergencias-container">
            <div class="loading">
                <div class="loading-spinner">‚è≥</div>
                <p>Presiona "Actualizar Ahora" para cargar las emergencias</p>
            </div>
        </div>

        <div class="footer">
            <p>Datos obtenidos de sgonorte.bomberosperu.gob.pe/24horas</p>
            <p>Sistema de monitoreo - Bomberos Toolkit</p>
        </div>
    </div>

    <script>
        async function obtenerEmergencias() {
            try {
                const res = await fetch('/api/emergencias');
                const data = await res.json();
                if(data.success) return data.emergencias;
                throw new Error(data.message || 'Error al obtener emergencias');
            } catch(e){ throw e; }
        }

        function getTipoEmergencia(tipo){
            if(tipo.includes('INCENDIO')) return {clase:'incendio'};
            if(tipo.includes('MEDICA')||tipo.includes('M√âDICA')) return {clase:'medica'};
            if(tipo.includes('PELIGROS')||tipo.includes('GAS')) return {clase:'peligroso'};
            return {clase:'peligroso'};
        }

        function renderizar(emergencias){
            const container=document.getElementById('emergencias-container');
            if(!emergencias||emergencias.length===0){
                container.innerHTML=`<div class="error-message"><div class="error-icon">‚ö†Ô∏è</div><h3>M√∫ltiples consultas detectadas</h3><p>Se han realizado varias consultas en poco tiempo. Por favor, espera un momento e intenta nuevamente.</p><p style="font-size:0.9rem;margin-top:10px;color:#6b7280;">Esto es una medida de seguridad del sistema.</p></div>`;
                return;
            }
            container.innerHTML=emergencias.map((e,i)=>{
                const tipoInfo=getTipoEmergencia(e.tipo);
                const esNueva=i===0;
                const sinCoordenadas=!e.lat||!e.lon||(e.lat===0&&e.lon===0);
                
                const botonesHTML=sinCoordenadas
                    ? `<div class="sin-coordenadas">üöí Pedir 10.18 a central</div>`
                    : `<div class="botones"><button class="btn btn-maps" onclick="abrirMaps(${e.lat},${e.lon})">üìç Abrir en Maps</button><button class="btn btn-waze" onclick="abrirWaze(${e.lat},${e.lon})">üöó Abrir en Waze</button></div>`;
                
                const maquinasHTML = e.maquinas ? `<div class="maquinas">üöí M√°quinas: ${e.maquinas}</div>` : '';
                
                return `<div class="emergencia-card ${tipoInfo.clase}">
                    ${esNueva?'<div class="badge-nueva">üÜï NUEVA</div>':''}
                    <div class="emergencia-info">
                        <div class="tipo">${e.tipo}</div>
                        <div class="direccion">üìç ${e.direccion}</div>
                        ${maquinasHTML}
                        <div class="tags">
                            <span class="tag tag-numero">#${e.parte}</span>
                            <span class="tag tag-estado">${e.estado}</span>
                        </div>
                        ${botonesHTML}
                    </div>
                </div>`;
            }).join('');
        }

        async function actualizarManual(){
            const btn=document.getElementById('btn-actualizar');
            const container=document.getElementById('emergencias-container');
            btn.disabled=true; btn.innerHTML='‚è≥ Actualizando...';
            container.innerHTML=`<div class="loading"><div class="loading-spinner">‚è≥</div><p>Obteniendo emergencias...</p></div>`;
            try{
                const emergencias=await obtenerEmergencias();
                renderizar(emergencias);
                const ahora=new Date();
                document.getElementById('ultima-actualizacion').innerHTML=`√öltima actualizaci√≥n: <strong>${ahora.toLocaleTimeString('es-PE')}</strong>`;
                btn.innerHTML='‚úÖ Actualizado';
                setTimeout(()=>{btn.innerHTML='Actualizar Ahora'; btn.disabled=false;},2000);
            } catch(e){
                container.innerHTML=`<div class="error-message"><div class="error-icon">‚ùå</div><h3>Error al obtener emergencias</h3><p>${e.message}</p><p style="font-size:0.9rem;margin-top:10px;">Intenta nuevamente en unos momentos</p></div>`;
                btn.innerHTML='Actualizar Ahora'; btn.disabled=false;
            }
        }

        function abrirMaps(lat,lng){window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,'_blank');}
        function abrirWaze(lat,lng){window.open(`https://waze.com/ul?ll=${lat},${lng}&navigate=yes`,'_blank');}

        // Actualizar autom√°ticamente al abrir la p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            actualizarManual();
        });
    </script>
</body>
</html>